name: CI

run-name: |
  ${{ github.event_name == 'schedule' && github.event.schedule == '0 */4 * * *' && 'ğŸ“° 4æ™‚é–“ãŠããƒ‹ãƒ¥ãƒ¼ã‚¹å‡¦ç†' ||
     github.event_name == 'schedule' && github.event.schedule == '*/5 * * * *' && 'ğŸ“¥ 5åˆ†ãŠããƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¤ãƒ³ãƒãƒ¼ãƒˆ' ||
     github.event_name == 'workflow_dispatch' && format('ğŸ”§ æ‰‹å‹•å®Ÿè¡Œ: æŠ•ç¨¿ID {0}', github.event.inputs.post_id) ||
     github.event_name == 'pull_request' && format('ğŸ” PRãƒ†ã‚¹ãƒˆ: {0} â†’ {1}', github.head_ref, github.base_ref) ||
     github.event_name == 'push' && format('ğŸš€ ãƒ—ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆ: {0}', github.ref_name) ||
     'ğŸ—ï¸ CIå®Ÿè¡Œ' }}

on:
  # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã¨ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«å®Ÿè¡Œ
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      post_id:
        description: 'æŠ•ç¨¿ID'
        required: true
        type: string
  # 4æ™‚é–“ãŠãã«å®Ÿè¡Œ
  schedule:
    - cron: '0 */4 * * *'  # 4æ™‚é–“ãŠãï¼ˆ00:00, 04:00, 08:00, 12:00, 16:00, 20:00ï¼‰
    - cron: '*/5 * * * *'   # 5åˆ†ãŠã

permissions:
  contents: read
  actions: read

jobs:
  # --- ãƒ—ãƒƒã‚·ãƒ¥ã‚„ãƒ—ãƒ«ãƒªã‚¯æ™‚ã«ã®ã¿å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ– ---
  test:
    # å®Ÿè¡Œæ¡ä»¶: ã‚¤ãƒ™ãƒ³ãƒˆãŒ 'schedule'ï¼ˆã‚¿ã‚¤ãƒãƒ¼ï¼‰ã§ã¯ãªã„æ™‚
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    - run: npm ci
    - run: npm test
    - run: npm run lint

  # --- 4æ™‚é–“ãŠãã«ãƒ‹ãƒ¥ãƒ¼ã‚¹å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ– ---
  news-processing:
    # å®Ÿè¡Œæ¡ä»¶: 4æ™‚é–“ãŠãã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚
    if: github.event_name == 'schedule' && github.event.schedule == '0 */4 * * *'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    - run: npm ci
    - name: Process News Only
      env:
        WP_URL: ${{ secrets.WP_URL }}
        WP_AUTH: ${{ secrets.WP_AUTH }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: npm run process-news

  # --- 5åˆ†ãŠãã«ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ– ---
  importing:
    # å®Ÿè¡Œæ¡ä»¶: 5åˆ†ãŠãã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚
    if: github.event_name == 'schedule' && github.event.schedule == '*/5 * * * *'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    - run: npm ci
    - name: Import News Only
      env:
        WP_URL: ${{ secrets.WP_URL }}
        WP_AUTH: ${{ secrets.WP_AUTH }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: npm run import-news